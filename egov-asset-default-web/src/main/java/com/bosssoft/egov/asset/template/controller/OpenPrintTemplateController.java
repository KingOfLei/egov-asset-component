/**
 * 福建博思软件 1997-2017 版权所有
 * Auto generated by Bosssoft Studio version 1.0 beta
 * Sun Jan 22 13:34:20 CST 2017
 */
package com.bosssoft.egov.asset.template.controller;

import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.OutputStream;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.bosssoft.egov.asset.log.annotations.Operation;
import com.bosssoft.egov.asset.runtime.User;
import com.bosssoft.egov.asset.runtime.web.context.AppContext;
import com.bosssoft.egov.asset.template.entity.AimsTemplateDetail;
import com.bosssoft.egov.asset.template.service.AimsTemplateDetailService;
import com.bosssoft.platform.common.lang.data.Page;
import com.bosssoft.platform.common.lang.data.Searcher;
import com.bosssoft.platform.runtime.exception.BusinessException;
import com.bosssoft.platform.runtime.web.response.GridData;
import com.bosssoft.platform.runtime.web.response.PageResult;

@Controller
@RequestMapping(value="open/egov/asset/template",name="aims_template_detail")
public class OpenPrintTemplateController {

	@Autowired
	private AimsTemplateDetailService aimsTemplateDetailService;
	 
	/**
	 * <p>函数名称：downLoad        </p>
	 * <p>功能说明：下载模板文件
	 *
	 * </p>
	 *<p>参数说明：</p>
	 * @param resp
	 * @param req
	 * @param tempId
	 *
	 * @date   创建时间：2017年3月3日
	 * @author 作者：黄振雄 (mailto:huangzhenxiong@bosssoft.com.cn) 
	 */
	 @Operation(comment = "下载模板文件")
	 @RequestMapping(value = "downLoad.do")
	 public void downLoad(HttpServletResponse resp, HttpServletRequest req, String tempId){
		 String[] temp = tempId.split("_");
		 Long templateId = new Long(temp[0]);
		 resp.setContentType("image/gif");// 设置信息内容格式
		 resp.addHeader("Access-Control-Allow-Origin","*") ;		
		 resp.setContentType("application/x-download");
		 
		 try {
			AimsTemplateDetail aimsTemplateDetail = aimsTemplateDetailService.queryOne(templateId);
			byte[] bcontent = aimsTemplateDetail.getModuleFile();
			OutputStream outputStream = new BufferedOutputStream(resp.getOutputStream());  
			resp.addHeader("Content-Disposition","attachment;filename=" + templateId+ "_"+ aimsTemplateDetail.getVersion() +".grf");
			outputStream.write(bcontent);  
			outputStream.flush();
			outputStream.close();   
		 } catch (IOException e) {
			// TODO Auto-generated catch block

		 }
				
	}
	 
	 
	/**
	 * <p>函数名称： queryTemplateDetailPage       </p>
	 * <p>功能说明：根据模板ID和单位ID获取模板分页信息
	 *
	 * </p>
	 *<p>参数说明：</p>
	 * @param searcher
	 * @param page
	 * @param moduleId
	 * @return
	 *
	 * @date   创建时间：2018年1月8日
	 * @author 作者：黄振雄 (mailto:huangzhenxiong@bosssoft.com.cn)
	 */
	@Operation(comment = "根据模板ID和单位ID获取模板分页信息")
	@RequestMapping(value="queryTemplateDetailPage.do",name="aims_template_detail分页查询")
	@ResponseBody
	public  GridData queryTemplateDetailPage(Searcher searcher, Page<AimsTemplateDetail> page, Long moduleId) {
		User user = AppContext.getAppContext().getSessionUser();
		Long orgId = user.getOrgLongId();
		if(moduleId == null){
			throw new BusinessException("模板ID不存在！");
		}
		return new GridData(new PageResult<AimsTemplateDetail>(aimsTemplateDetailService.queryTemplateDetailPageByOrgId(searcher, page, moduleId, orgId)));
	}
	
	/**
	 * <p>函数名称：queryTempName        </p>
	 * <p>功能说明：
	 *
	 * </p>
	 *<p>参数说明：</p>
	 * @param req
	 * @param resp
	 * @param ffileName
	 * @return
	 *
	 * @date   创建时间：2018年1月8日
	 * @author 作者：黄振雄 (mailto:huangzhenxiong@bosssoft.com.cn)
	 */
	@RequestMapping("queryTempName.do")
	@ResponseBody
	public String queryTempName(HttpServletRequest req,HttpServletResponse resp,String ffileName){
		resp.setContentType("image/gif");// 设置信息内容格式
		resp.setContentType("utf-8") ;
		resp.addHeader("Access-Control-Allow-Origin","*");
		AimsTemplateDetail template=null;
		String tempName ="";
		//如果文件名不为空，则根据文件名称查询
		if(ffileName!=null&&(!"".equals(ffileName))){
			template = aimsTemplateDetailService.queryOneByFileName(ffileName);			
		}
		if(template!=null)
			tempName = template.getModuleItemId()+"_"+String.valueOf(template.getVersion()) ; 
		return tempName;
	}
}